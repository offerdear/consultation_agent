<!DOCTYPE html>
<html>
<head>
    <title>Student Intake</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Dekko&&family=Mali:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <style>
        .loading-dots {
            display: inline-block;
        }
        .dot {
            opacity: 0;
            animation: dot 1.4s infinite;
            animation-fill-mode: both;
        }
        .dot:nth-child(1) { animation-delay: 0s; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dot {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        .category-button {
            transition: all 0.3s ease;
        }

        .category-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        h1, h2, h3, h4 {
            font-family: 'Dekko', sans-serif;
        }

        .chat-identity {
            font-family: 'Mali', sans-serif;
            font-weight: 500;
        }

        .chat-text {
            font-family: 'Mali', sans-serif;
            color: rgb(70, 92, 72);
        }

        .font-mali {
            font-family: 'Mali';
        }

    </style>
</head>
<body class="bg-[#fcfcf7] p-4">
    {% include "navbar.html" %}
    <div class="max-w-2xl mx-auto h-200">
        <h1 class="text-3xl mt-8 mb-8 text-center text-[#A5D6A7]">Student Intake Assistant</h1>
        <div class="rounded-lg shadow-g p-4">
            <div id="chat-messages" class="h-[470px] overflow-y-auto mb-4 p-2 flex flex-col gap-4">
                <div class="bg-[] mr-8 p-3 rounded-lg border-l-4 border-2 border-[#A5D6A7]">
                    <strong class="text-slate-700 chat-identity">Assistant:</strong>
                    <p class="mt-1 chat-text">Welcome! I'm here to help you get started with our tutoring service. 
                        What are you interested in today?</p>
                    <div id="initial-choices" class="mt-3 space-y-2">
                        <div class="text-center text-gray-500 py-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="mt-2 text-sm">Loading choices...</p>
                        </div>
                    </div>
                    <div id="initial-categories" class="mt-3 space-y-2">
                        <div class="text-center text-gray-500 py-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
                            <p class="mt-2 text-sm">Loading categories...</p>
                        </div>
                    </div>
        
                </div>
            </div>

            <div class="flex space-x-2">
                <input type="text" id="user-input"
                       class="flex-1 border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="Type your message...">
                <button onclick="sendMessage()"
                        class="bg-[#644358] hover:bg-blue-600 text-white px-6 rounded-lg transition-colors">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced chatbot variables
        let modes = ["Consultation", "FAQ"]
        let chatCategories = ["Curriculum", "Pricing", "Teachers", "Textbooks", "More Info", "Contact", "Other"];
        let categoryFAQs = new Map(); // Map of category -> FAQ array
        let selectedCategory = '';
        let isChatOpen = false;
        let chatInitialized = false;
        let categories = new Set(chatCategories); // Global categories set
        let conversationMode = null; // 'faq' or 'consultation'
        let currentSessionId = null;

        // DOM elements
        const userInput = document.getElementById('user-input');

        // Initialize the application
        async function initializeApp() {
            try {
                if (!chatInitialized) {
                    await initializeChatbot();
                    chatInitialized = true;
                }
            } catch (error) {
                console.error('Failed to initialize app:', error);
                if (document.getElementById('chat-messages')) {
                    addMessage('System', 'Failed to load application. Please refresh the page.');
                }
            }
        }
       
        // =================== ENHANCED CHATBOT FUNCTIONALITY ===================

        // Initialize chatbot
        async function initializeChatbot() {
            try {
                await loadChatCategories();
                setupChatEventListeners();
            } catch (error) {
                console.error('Failed to initialize chatbot:', error);
                addMessage('System', 'Failed to load categories. Please refresh the page.');
            }
        }

        // Setup chat event listeners
        function setupChatEventListeners() {
            // Enter key to send message
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        // Load and display categories for chatbot
        async function loadChatCategories() {
            try {
                // Use existing categories from knowledge base data 
                // CHANGE! 
                chatCategories = Array.from(categories);
                
                // Build FAQ mapping by category
                categoryFAQs.clear();

                //
                //allLines.forEach(line => {
                //    if (line.Category) {

                        
                //        // Build FAQ mapping
                //        if (!categoryFAQs.has(product.Category)) {
                //            const faqs = extractFAQsFromProduct(product);
                //            if (faqs.length > 0) {
                //                categoryFAQs.set(product.Category, faqs);
                //            }
                //        }
                //    }
                //});
                
                // Update initial option buttons
                displayInitialOptions()
                
            } catch (error) {
                console.error('Error loading chat categories:', error);
                throw error;
            }
        }

        // Display initial consultation options
        function displayInitialOptions() {
            const initialDiv = document.getElementById('initial-choices');

            initialDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    ${modes.map(mode => `
                        <button onclick="selectMode('${mode}')" 
                                class="category-button 
                                       py-2 px-3 text-xs font-medium text-gray-700 
                                       bg-neutral-50 hover:bg-neutral-100 
                                       border border-zinc-200 rounded-md">
                            ${mode}
                        </button>
                    `).join('')}
                </div>
                
            `;

            /**
             * <div class="space-y-3">
                    <button onclick="selectMode('faq')" 
                            class="w-full p-4 text-left bg-blue-50 hover:bg-blue-100 
                            border border-blue-200 rounded-lg transition-colors">
                        <h3 class="font-semibold text-black-600">I have questions about courses</h3>
                        <p class="text-sm text-blue-600 mt-1">Ask about curriculum, teachers, pricing, etc.</p>
                    </button>
                    <button onclick="selectMode('consultation')" 
                            class="w-full p-4 text-left bg-green-50 hover:bg-green-100 
                                border border-green-200 rounded-lg transition-colors">
                        <h3 class="font-semibold text-black-600">I want a consultation for my child</h3>
                        <p class="text-sm text-green-600 mt-1">Get a diagnostic and personalized course recommendations</p>
                    </button>
                </div>
             **/
        }

        // Display initial category selection buttons in chat
        function displayInitialChatCategories() {
            const initialCategoriesDiv = document.getElementById('initial-categories');
            
            if (chatCategories.length === 0) {
                initialCategoriesDiv.innerHTML = '<p class="text-red-500 text-center">No categories available</p>';
                return;
            }

            initialCategoriesDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    ${chatCategories.map(category => `
                        <button onclick="selectChatCategory('${category}')" 
                                class="category-button 
                                       py-2 px-3 text-xs font-medium text-gray-700 
                                       bg-neutral-50 hover:bg-neutral-100 
                                       border border-zinc-200 rounded-md">
                            ${category}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        function selectMode(mode) {
            conversationMode = mode;
            
            // Clear initial choices
            document.getElementById('initial-choices').innerHTML = '';
            document.getElementById('initial-categories').innerHTML = '';
            
            if (mode === 'Consultation') {
                addMessage('You', 'I would like a consultation');
                startConsultation();
            } else if (mode === 'FAQ') {
                addMessage('You', 'I have questions about your programs');
                addMessage('Assistant', "I'd be happy to answer your questions! Please select which topic you're interested in:");
                displayInitialChatCategories();
            }
        }
        /**function selectMode(mode) {
            conversationMode = mode;
            
            if (mode === 'Consultation') {
                addMessage('You', 'I would like a consultation for my child');
                addMessage('Assistant', "I'd be happy to help you find the perfect English courses for your child! First, may I have your name or your child's name?");

                userInput.focus();
                name = userInput.value
                userInput.value = "My name is ";

                if (name) {
                    
                    addMessage('Assistant', 
                        `Thanks ${name}. Could you tell me your child's current English 
                        level (beginner/intermediate/advanced) and a brief goal?`);
                } else {
                    addMessage('Assistant', "Please let me know your name first.");
                }

                // Show existing FAQ categories
                displayFAQCategories();
            }
        }**/

        // Select category from button click (enhanced with FAQ flow)
        async function selectChatCategory(category) {
            selectedCategory = category;
            
            // Add user message
            addMessage('You', `I would like to know more about ${category}.`);
            
            // Check if we have FAQs for this category
            const faqs = categoryFAQs.get(category);
            
            if (faqs && faqs.length > 0) {
                // Show FAQ options first
                displayCategoryFAQs(category, faqs);
            } else {
                addMessage('Assistant', `Great! Let me know what you would like to know.`);
            }
        }

        // Display FAQ options for the selected category
        function displayCategoryFAQs(category, faqs) {
            const faqButtons = faqs.map((faq, index) => `
                <button onclick="selectFAQ('${category}', ${index})" 
                        class="w-full text-left p-3 mb-2 text-sm 
                                bg-neutral-50 hover:bg-slate-200 
                                border border-slate-200 rounded-lg 
                                text-gray-800 transition-colors">
                    ${faq.question}
                </button>
            `).join('');

            addMessage('Assistant', 
                `Here are some common questions about ${category}. Click on one, or skip to describe your specific problem:`,
                `<div class="mt-3">${faqButtons}</div>`
            );
        }

        // Handle FAQ selection
        function selectFAQ(category, faqIndex) {
            const faqs = categoryFAQs.get(category);
            const selectedFAQ = faqs[faqIndex];
            
            // Add user message showing they selected this FAQ
            addMessage('You', selectedFAQ.question);
            
            // Provide the FAQ answer
            addMessage('Assistant', selectedFAQ.answer);
            
            // Offer follow-up options
            setTimeout(() => {
                const followUpButtons = `
                    <div class="mt-3 space-y-2">
                        <button onclick="selectDifferentFAQ('${category}')" 
                                class="w-full p-2 text-sm bg-gray-100 hover:bg-gray-200 
                                    border border-gray-300 rounded-lg text-gray-700 transition-colors">
                            Look at other common questions about ${category}
                        </button>
                        <button onclick="resetChatFlow()" 
                                class="w-full p-2 text-sm bg-green-100 hover:bg-green-200 
                                    border border-green-300 rounded-lg text-green-800 transition-colors">
                            Start over with different category
                        </button>
                    </div>
                `;
                
                addMessage('Assistant', 
                    "Was this helpful? What would you like to do next?",
                    followUpButtons
                );
            }, 1000);
        }

        /** // Show different FAQ for same category
        function selectDifferentFAQ(category) {
            const faqs = categoryFAQs.get(category);
            addMessage('You', "I'd like to see other common questions");
            displayCategoryFAQs(category, faqs);
        } 

        // Reset chat flow to start over
        function resetChatFlow() {
            selectedCategory = '';
            addMessage('You', "I'd like to know about something else");
            addMessage('Assistant', "Of course! Please select the topic you're interested in", '', 'mt-2');
            
            displayInitialChatCategories();
        } **/

        /** Enhanced send message function with better context
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Enhanced category validation: required only for FAQ mode
            if (conversationMode === 'faq' && !selectedCategory) {
                addMessage('Assistant', 
                    `Please first select a category by clicking one of the buttons above. 
                    This helps me provide you with more specific assistance and show you 
                    relevant frequently asked questions.`);
                return;
            }

            // Add user message
            addMessage('You', message);
            //userInput.value = '';

            // Add loading message
            const loadingId = addLoadingMessage();

            // Call the agentic API with enhanced context
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        category: selectedCategory || null,
                        mode: conversationMode || 'faq',
                        session_id: window.sessionId || null,
                        context: 'other' // Indicates this is a custom question, not FAQ
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Remove loading message and add actual response
                removeLoadingMessage(loadingId);
                addMessage('Assistant', data.response);
                
                // Offer follow-up options after API response
                setTimeout(() => {
                    offerFollowUpOptions();
                }, 3000);
                
            } catch (error) {
                console.error('Error calling agentic API:', error);
                removeLoadingMessage(loadingId);
                addMessage('System', 'Sorry, I encountered an error connecting to the support system. Please try again.');
            }
        } **/

        /**
        // Offer follow-up options after providing support
        function offerFollowUpOptions() {
            const followUpButtons = `
                <div class="mt-3 space-y-2">
                    <button onclick="askAnotherQuestion()" 
                            class="w-full p-2 text-sm bg-neutral-50 hover:bg-stone-100 
                                border border-stone-200 rounded-lg text-gray-800 transition-colors">
                        Ask another question about ${selectedCategory}
                    </button>
                    <button onclick="resetChatFlow()" 
                            class="w-full p-2 text-sm bg-neutral-50 hover:bg-stone-100 
                                border border-stone-200 rounded-lg text-gray-800 transition-colors">
                        Help with different category
                    </button>
                </div>
            `;
            
            addMessage('Assistant', 
                "Is there anything else I can help you with?",
                followUpButtons
            );
        }**/

        /**
        // Ask another question for same category
        function askAnotherQuestion() {
            addMessage('You', `I have another question about ${selectedCategory}`);
            addMessage('Assistant', `Sure! What else would you like to know about ${selectedCategory}?`);
        }**/

        // Add loading message
        function addLoadingMessage() {
            const chat = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            messageDiv.id = loadingId;
            messageDiv.className = 'p-3 rounded-lg bg-gray-100 mr-8';
            messageDiv.innerHTML = `
                <strong class="text-slate-600">Assistant:</strong> 
                <span class="ml-2">Thinking</span>
                <span class="loading-dots ml-1">
                    <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
                </span>
            `;
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
            return loadingId;
        }

        // Remove loading message
        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        /*** Add message to chat ***/
        function addMessage(sender, message, extraContent = '', extraClass = '') {
            const chat = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            let senderClass = '';
            let senderColor = '';
            let alignment = '';
            
            if (sender === 'You') {
                senderClass = 'ml-8 border-r-4 border-2 border-[#a39872] text-[#736843] font-mali';
                senderColor = '#736843';
                alignment = 'self-end';
            } else if (sender === 'Assistant') {
                senderClass = 'mr-8 border-l-4 border-2 border-[#A5D6A7] text-[#465c48] font-mali';
                alginment = 'self-start';
            } else if (sender === 'System') {
                senderClass = 'bg-red-100 border-4 border-red-500';
                senderColor = 'text-red-600';
            }

            messageDiv.className = `p-3 rounded-lg ${senderClass} ${extraClass} ${alignment}`;
                        
            const formattedMessage = message.replace(/\n/g, '<br>');

            let content = `<strong style="color: ${senderColor};">${sender}:</strong> <span class="mt-1">${formattedMessage}</span>`;
            if (extraContent) {
                content += `<div class="mt-2">${extraContent}</div>`;
            }
            
            messageDiv.innerHTML = content;
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        // Initialize session
        function generateSessionId() {
            if (!currentSessionId) {
                currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }
            return currentSessionId;
        }

        // Start consultation flow
        async function startConsultation() {
            try {
                const response = await fetch('/api/consultation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'start',
                        session_id: generateSessionId()
                    })
                });

                const data = await response.json();
                handleConsultationResponse(data);
                
            } catch (error) {
                console.error('Error starting consultation:', error);
                addMessage('System', 'Sorry, I encountered an error starting the consultation. Please try again.');
            }
        }

        // Handle consultation responses and render UI elements
        function handleConsultationResponse(data) {
            // Add the text response
            addMessage('Assistant', data.response);
            
            // Render UI elements based on response type
            if (data.ui_elements) {
                renderUIElements(data.ui_elements);
            }
            
            // Update text input state
            const textInput = document.getElementById('user-input');
            if (data.allow_text_input) {
                textInput.style.display = 'block';
                if (data.text_fallback) {
                    textInput.placeholder = data.text_fallback;
                }
            } else {
                textInput.style.display = 'none';
            }
        }

        // Render different types of UI elements
        function renderUIElements(uiElements) {
            const chat = document.getElementById('chat-messages');
            const elementDiv = document.createElement('div');
            elementDiv.className = 'ui-elements mt-3';
            
            switch (uiElements.type) {
                case 'form':
                    elementDiv.innerHTML = renderForm(uiElements);
                    break;
                case 'multi_section':
                    elementDiv.innerHTML = renderMultiSection(uiElements);
                    break;
                case 'button_grid':
                    elementDiv.innerHTML = renderButtonGrid(uiElements);
                    break;
                case 'action_buttons':
                    elementDiv.innerHTML = renderActionButtons(uiElements);
                    break;
                case 'question_interface':
                    elementDiv.innerHTML = renderQuestionInterface(uiElements);
                    break;
                case 'results_display':
                    elementDiv.innerHTML = renderResultsDisplay(uiElements);
                    break;
                case 'course_recommendations':
                    elementDiv.innerHTML = renderCourseRecommendations(uiElements);
                    break;
            }
            
            chat.appendChild(elementDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        // Render form interface
        function renderForm(uiElements) {
            let html = '<div class="space-y-4">';
            
            uiElements.fields.forEach(field => {
                const requiredAttr = field.required ? 'required' : '';
                const requiredLabel = field.required ? ' *' : '';
                
                html += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ${field.label}${requiredLabel}
                        </label>
                        <input type="${field.type}" 
                            id="form_${field.id}" 
                            placeholder="${field.placeholder}"
                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            ${requiredAttr}>
                    </div>
                `;
            });
            
            html += `
                <button onclick="submitForm('${uiElements.action}')" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ${uiElements.submit_button}
                </button>
            </div>`;
            
            return html;
        }

        // Render multi-section interface (age + level selection)
        function renderMultiSection(uiElements) {
            let html = '<div class="space-y-6">';
            
            uiElements.sections.forEach(section => {
                html += `
                    <div>
                        <h3 class="font-medium text-gray-800 mb-3">${section.title}</h3>
                        ${renderSectionContent(section)}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

                // Render section content based on type
        function renderSectionContent(section) {
            if (section.type === 'button_grid') {
                return renderButtonGrid(section);
            }
            return '';
        }

        // Render button grid
        function renderButtonGrid(uiElements) {
            let html = '<div class="grid grid-cols-2 gap-3">';
            
            uiElements.buttons.forEach(button => {
                const subtitle = button.subtitle ? `<div class="text-xs text-gray-500 mt-1">${button.subtitle}</div>` : '';
                html += `
                    <button onclick="handleButtonClick('${button.id}', '${button.action}')"
                            class="p-3 text-left bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-colors">
                        <div class="text-sm font-medium text-gray-800">${button.text}</div>
                        ${subtitle}
                    </button>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // Render action buttons
        function renderActionButtons(uiElements) {
            let html = '<div class="flex space-x-3 justify-center">';
            
            uiElements.buttons.forEach(button => {
                const styleClass = button.style === 'primary' 
                    ? 'bg-blue-500 hover:bg-blue-600 text-white'
                    : 'bg-gray-200 hover:bg-gray-300 text-gray-800';
                    
                html += `
                    <button onclick="handleButtonClick('${button.id}', '${button.action}')"
                            class="${styleClass} px-6 py-2 rounded-lg transition-colors font-medium">
                        ${button.text}
                    </button>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // Render question interface with progress bar
        function renderQuestionInterface(uiElements) {
            const progress = uiElements.progress;
            
            let html = `
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Question ${progress.current} of ${progress.total}</span>
                        <span>${progress.percentage}% Complete</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" 
                            style="width: ${progress.percentage}%"></div>
                    </div>
                </div>
                
                <div class="space-y-2">
            `;
            
            uiElements.answers.forEach(answer => {
                html += `
                    <button onclick="handleButtonClick('${answer.id}', '${answer.action}')"
                            class="w-full text-left p-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg transition-colors">
                        ${answer.text}
                    </button>
                `;
            });
    
            html += '</div>';
            return html;
        }

        // Render assessment results
        function renderResultsDisplay(uiElements) {
            const score = uiElements.score;
            
            let html = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2">${score.correct}/${score.total}</div>
                    <div class="text-lg text-green-700 mb-2">${score.percentage}% Correct</div>
                    <div class="text-sm text-gray-600 mb-4">Recommended Level: <span class="font-semibold text-green-700">${score.level.toUpperCase()}</span></div>
                    
                    <button onclick="handleButtonClick('${uiElements.next_button.id}', '${uiElements.next_button.action}')"
                            class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors font-medium">
                        ${uiElements.next_button.text}
                    </button>
                </div>
            `;
            
            return html;
        }

        // Render course recommendations
        function renderCourseRecommendations(uiElements) {
            let html = '<div class="space-y-4">';
            
            // Course cards
            uiElements.courses.forEach(course => {
                html += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-gray-800">${course.text}</h4>
                            <button onclick="handleButtonClick('${course.id}', '${course.action}')"
                                    class="text-blue-500 hover:text-blue-700 text-sm">
                                View Details
                            </button>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">${course.subtitle}</div>
                        <p class="text-sm text-gray-700">${course.description}</p>
                    </div>
                `;
            });
            
            // Action buttons
            html += '<div class="flex space-x-3 justify-center mt-6">';
            uiElements.action_buttons.forEach(button => {
                const styleClass = button.style === 'primary' 
                    ? 'bg-blue-500 hover:bg-blue-600 text-white'
                    : 'bg-gray-200 hover:bg-gray-300 text-gray-800';
                    
                html += `
                    <button onclick="handleButtonClick('${button.id}', '${button.action}')"
                            class="${styleClass} px-6 py-2 rounded-lg transition-colors font-medium">
                        ${button.text}
                    </button>
                `;
            });
            html += '</div>';
            
            html += '</div>';
            return html;
        }

        // Handle button clicks
        async function handleButtonClick(buttonId, action) {
            // Add user message showing what they clicked
            const buttonText = document.querySelector(`button[onclick*="${buttonId}"]`)?.textContent || buttonId;
            addMessage('You', buttonText);
            
            // Send consultation message
            await sendConsultationMessage(buttonId, 'button_click');
        }

        // Handle form submissions (debugging version)
async function submitForm(action) {
    console.log('Form submission started');
    
    const formData = {};
    const inputs = document.querySelectorAll('input[id^="form_"]');
    console.log('Found inputs:', inputs.length);
    
    let isValid = true;
    inputs.forEach((input, index) => {
        const fieldId = input.id.replace('form_', '');
        const value = input.value.trim();
        const isRequired = input.hasAttribute('required');
        
        console.log(`Field ${index}:`, {
            id: fieldId,
            value: value,
            required: isRequired,
            hasValue: !!value
        });
        
        if (isRequired && !value) {
            input.classList.add('border-red-500');
            isValid = false;
            console.log(`Field ${fieldId} is required but empty`);
        } else {
            input.classList.remove('border-red-500');
            if (value) {
                formData[fieldId] = value;
            }
        }
    });
    
    console.log('Form data:', formData);
    console.log('Is valid:', isValid);
    
    if (!isValid) {
        addMessage('System', 'Please fill in all required fields.');
        return;
    }
    
    if (Object.keys(formData).length === 0) {
        addMessage('System', 'Please enter your information.');
        return;
    }
    
    // Add user message showing form data
    const formSummary = Object.entries(formData).map(([key, value]) => `${key}: ${value}`).join(', ');
    addMessage('You', formSummary);
    
    // Send form data
    await sendConsultationMessage(JSON.stringify(formData), 'form_submit');
}
        
        /**async function submitForm(action) {
            const formData = {};
            const inputs = document.querySelectorAll('input[id^="form_"]');
            
            let isValid = true;
            inputs.forEach(input => {
                const fieldId = input.id.replace('form_', '');
                const value = input.value.trim();
                
                // Check if field is required (look for 'required' attribute)
                const isRequired = input.hasAttribute('required');
                
                if (isRequired && !value) {
                    input.classList.add('border-red-500');
                    isValid = false;
                } else {
                    input.classList.remove('border-red-500');
                    if (value) {  // Only add non-empty values
                        formData[fieldId] = value;
                    }
                }
            });
            
            if (!isValid) {
                addMessage('System', 'Please fill in all required fields.');
                return;
            }
            
            // Validate we actually have data
            if (Object.keys(formData).length === 0) {
                addMessage('System', 'Please enter your information.');
                return;
            }
            
            // Add user message showing form data
            const formSummary = Object.entries(formData).map(([key, value]) => `${key}: ${value}`).join(', ');
            addMessage('You', formSummary);
            
            // Send form data
            await sendConsultationMessage(JSON.stringify(formData), 'form_submit');
        }**/

        // Send consultation message to backend
        async function sendConsultationMessage(message, actionType = 'text') {
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch('/api/consultation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        action_type: actionType,
                        session_id: currentSessionId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                removeLoadingMessage(loadingId);
                handleConsultationResponse(data);
                
            } catch (error) {
                console.error('Error calling consultation API:', error);
                removeLoadingMessage(loadingId);
                addMessage('System', 'Sorry, I encountered an error. Please try again.');
            }
        }

        // Updated main send message function
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Clear input
            userInput.value = '';

            if (conversationMode === 'Consultation') {
                addMessage('You', message);
                await sendConsultationMessage(message, 'text');
            } else if (conversationMode === 'FAQ') {
                if (!selectedCategory) {
                    addMessage('Assistant', 'Please first select a category by clicking one of the buttons above.');
                    return;
                }
                
                addMessage('You', message);
                await sendFAQMessage(message);
            } else {
                addMessage('You', message);
                await sendInitialMessage(message);
            }
        }

        // Existing FAQ and initial message functions remain the same...
        async function sendFAQMessage(message) {
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        category: selectedCategory,
                        mode: 'FAQ',
                        session_id: currentSessionId || generateSessionId()
                    })
                });

                        const data = await response.json();
                        
                        removeLoadingMessage(loadingId);
                        addMessage('Assistant', data.response);
                        
                        setTimeout(() => {
                            offerFollowUpOptions();
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Error calling FAQ API:', error);
                        removeLoadingMessage(loadingId);
                        addMessage('System', 'Sorry, I encountered an error. Please try again.');
                    }
                }

                async function sendInitialMessage(message) {
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        mode: null,
                        session_id: currentSessionId || generateSessionId()
                    })
                });

                const data = await response.json();
                
                removeLoadingMessage(loadingId);
                addMessage('Assistant', data.response);
                
            } catch (error) {
                console.error('Error:', error);
                removeLoadingMessage(loadingId);
                addMessage('System', 'Sorry, I encountered an error. Please try again.');
            }
        }


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp(); // Call your centralized init function
        });

    </script>
</body>
</html>